#!/usr/bin/env bash
set -e

if ! docker image inspect emptyfs > /dev/null; then
	# build a "docker save" tarball for "emptyfs"
	# see https://github.com/docker/docker/pull/5262
	# and also https://github.com/docker/docker/issues/4242
	dir="$DEST/emptyfs"
	layerid=269cb3feb538d91d2c38c78063d287bdc9a11098e4266d141087d6c61f4f42ec
	mkdir -p "$dir/$layerid"
	(
		config="11f64303f0f7ffdc71f001788132bca5346831939a956e3e975c93267d89a16d"
		echo "[{\"Config\":\"$config.json\",\"RepoTags\":[\"emptyfs:latest\"],\"Layers\":[\"$layerid/layer.tar\"]}]" > "$dir/manifest.json"
		echo '{"architecture":"x86_64","comment":"Imported from -","container_config":{"Hostname":"","Domainname":"","User":"","AttachStdin":false,"AttachStdout":false,"AttachStderr":false,"Tty":false,"OpenStdin":false,"StdinOnce":false,"Env":null,"Cmd":null,"Image":"","Volumes":null,"WorkingDir":"","Entrypoint":null,"OnBuild":null,"Labels":null},"created":"2013-06-13T14:03:50.821769-07:00","docker_version":"0.4.0","history":[{"created":"2013-06-13T14:03:50.821769-07:00","comment":"Imported from -"}],"rootfs":{"type":"layers","diff_ids":["sha256:84ff92691f909a05b224e1c56abb4864f01b4f8e3c854e4bb4c7baf1d3f6d652"]}}' > "$dir/$config.json"
		tar -cf "$dir/$layerid/layer.tar" --files-from /dev/null
	)
	(
		[ -n "$TESTDEBUG" ] && set -x
		tar -cC "$dir" . | docker load
		docker images
	)
	rm -rf "$dir"
fi
